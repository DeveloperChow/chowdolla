<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover" />
<meta name="theme-color" content="#0b0f14" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
<meta name="apple-mobile-web-app-title" content="ChowDolla" />
<title>ChowDolla</title>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
:root{
  --bg:#060a12;
  --card:rgba(16,22,34,.55);
  --card2:rgba(10,14,22,.35);
  --line:rgba(255,255,255,.10);
  --text:#e9eef7;
  --muted:rgba(233,238,247,.55);
  --muted2:rgba(233,238,247,.35);
  --brand:#4f7cff;
  --brand2:#2b55ff;
  --good:#22c55e;
  --bad:#ef4444;
  --shadow:0 24px 80px rgba(0,0,0,.55);
  --radius:26px;
}

*{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
html,body{height:100%}
body{
  margin:0;
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
  color:var(--text);
  background:
    radial-gradient(900px 600px at 20% 10%, rgba(79,124,255,.20) 0%, rgba(6,10,18,0) 55%),
    radial-gradient(700px 520px at 80% 20%, rgba(120,90,255,.16) 0%, rgba(6,10,18,0) 55%),
    radial-gradient(1100px 900px at 50% 80%, rgba(255,255,255,.03) 0%, rgba(6,10,18,0) 60%),
    var(--bg);
  overflow:hidden;
}

.hidden{display:none}

.safe{
  height:100%;
  overflow:auto;
  overscroll-behavior:none;
  padding:calc(env(safe-area-inset-top) + 14px) 14px calc(env(safe-area-inset-bottom) + 104px);
}

.card{
  border:1px solid var(--line);
  border-radius:var(--radius);
  background:linear-gradient(180deg, var(--card), var(--card2));
  box-shadow:var(--shadow);
  backdrop-filter: blur(14px);
}

.authCard{
  padding:18px;
  max-width:520px;
  margin:0 auto;
}

.sep{height:1px;background:rgba(255,255,255,.08);margin:14px 0}

input{
  width:100%;
  padding:12px 12px;
  border-radius:16px;
  border:1px solid rgba(255,255,255,.10);
  background:rgba(0,0,0,.18);
  color:var(--text);
  outline:none;
  font-size:16px;
}

button{
  border:none;
  border-radius:18px;
  padding:12px 12px;
  font-size:16px;
  font-weight:900;
  color:var(--text);
  background:rgba(79,124,255,.92);
  box-shadow:0 14px 34px rgba(79,124,255,.18);
  transition:transform .08s ease, opacity .2s ease;
  user-select:none;
}
button:active{transform:scale(.985)}
.btnGhost{
  background:rgba(255,255,255,.06);
  border:1px solid rgba(255,255,255,.10);
  box-shadow:none;
}
.btnBad{background:rgba(239,68,68,.92);box-shadow:0 14px 34px rgba(239,68,68,.14)}
.btnGold{background:rgba(251,191,36,.95);color:#101010;box-shadow:0 14px 34px rgba(251,191,36,.14)}

.row{display:flex;gap:10px;align-items:center}
.small{font-size:12px;color:var(--muted)}
.muted{color:var(--muted)}
.muted2{color:var(--muted2)}
.center{text-align:center}

.page{display:none;animation:fade .16s ease}
.page.active{display:block}
@keyframes fade{from{opacity:.5;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}

/* HOME (match your screenshot) */
.homeWrap{
  max-width:560px;
  margin:0 auto;
}
.homeCard{
  padding:18px 16px 18px;
}
.headerRow{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:12px;
}
.brandLeft{display:flex;gap:12px;align-items:center}
.logo{
  width:46px;height:46px;border-radius:18px;
  display:grid;place-items:center;
  background:linear-gradient(180deg, rgba(120,160,255,.95), rgba(79,124,255,.85));
  box-shadow:0 16px 34px rgba(79,124,255,.20), inset 0 0 0 1px rgba(255,255,255,.16);
  font-weight:1000;letter-spacing:.5px;
}
.brandText{display:flex;flex-direction:column;gap:3px}
.brandText .t{font-weight:1000;letter-spacing:2px}
.brandText .s{font-size:12px;color:var(--muted);letter-spacing:1px}
.onlinePill{
  padding:8px 14px;
  border-radius:999px;
  border:1px solid rgba(255,255,255,.10);
  background:rgba(0,0,0,.20);
  color:var(--muted);
  font-size:12px;
  white-space:nowrap;
}

.welcome{margin-top:22px; text-align:center}
.welcome .w1{color:var(--muted);letter-spacing:2px;text-transform:lowercase}
.welcome .w2{margin-top:6px;font-size:28px;font-weight:1000}

.progressWrap{margin-top:18px}
.track{
  height:18px;
  border-radius:999px;
  border:1px solid rgba(255,255,255,.12);
  background:rgba(255,255,255,.06);
  overflow:hidden;
}
.fill{
  height:100%;
  width:0%;
  border-radius:999px;
  background:linear-gradient(90deg, rgba(79,124,255,.95), rgba(120,160,255,.85));
  box-shadow:0 10px 26px rgba(79,124,255,.14);
}
.progLabel{
  margin-top:10px;
  text-align:center;
  font-size:16px;
  color:var(--muted);
  letter-spacing:1px;
}
.progLabel b{color:var(--text)}

.balanceBlock{margin-top:18px;text-align:center}
.balanceBlock .b1{color:var(--muted);letter-spacing:2px;text-transform:lowercase}
.balanceBlock .b2{margin-top:8px;font-size:56px;font-weight:1000;letter-spacing:1px}
.balanceBlock .b3{margin-top:4px;color:var(--muted);letter-spacing:1px}

.statRow{
  margin-top:20px;
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:14px;
}
.statBox{
  padding:16px;
  border-radius:22px;
  border:1px solid rgba(255,255,255,.10);
  background:rgba(0,0,0,.12);
  text-align:center;
}
.statBox .k{color:var(--muted);letter-spacing:2px;text-transform:lowercase}
.statBox .v{margin-top:6px;font-size:34px;font-weight:1000}

.claimRow{
  margin-top:18px;
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:14px;
}
.claimBox{
  padding:18px;
  border-radius:26px;
  border:1px solid rgba(255,255,255,.10);
  background:rgba(0,0,0,.12);
  text-align:center;
  user-select:none;
}
.claimBox.ready{
  border-color:rgba(79,124,255,.35);
  box-shadow:0 0 0 1px rgba(79,124,255,.18), 0 18px 44px rgba(79,124,255,.14);
}
.claimBox .c1{color:var(--muted);letter-spacing:3px;font-weight:900}
.claimBox .c2{margin-top:10px;font-size:44px;font-weight:1000}
.claimBox .c3{margin-top:6px;color:var(--muted);font-size:18px;letter-spacing:2px}

.tapBtn{
  margin-top:18px;
  width:100%;
  padding:22px 16px;
  border-radius:26px;
  border:1px solid rgba(79,124,255,.35);
  background:linear-gradient(180deg, rgba(79,124,255,.32), rgba(79,124,255,.14));
  box-shadow:
    0 18px 70px rgba(79,124,255,.22),
    inset 0 0 0 1px rgba(255,255,255,.08);
  font-size:54px;
  letter-spacing:4px;
  text-transform:uppercase;
}
.tapHint{
  margin-top:12px;
  text-align:center;
  color:var(--muted);
  letter-spacing:1.5px;
}

/* other pages */
.sectionCard{
  max-width:560px;
  margin:0 auto;
  padding:16px;
}
.listItem{
  border:1px solid rgba(255,255,255,.10);
  background:rgba(0,0,0,.12);
  border-radius:20px;
  padding:12px;
  margin-top:10px;
}
.listTop{display:flex;justify-content:space-between;gap:10px;align-items:center}
.amtIn{color:var(--good);font-weight:1000}
.amtOut{color:var(--bad);font-weight:1000}
.badge{font-size:11px;padding:6px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.10);color:var(--muted)}
.badgeOk{color:var(--good);border-color:rgba(34,197,94,.35);background:rgba(34,197,94,.10)}
.msgBubble{margin-top:8px;padding:10px;border-radius:14px;border:1px solid rgba(255,255,255,.10);background:rgba(255,255,255,.05)}
.msgMe{background:rgba(79,124,255,.16);border-color:rgba(79,124,255,.26)}
.pfpRow{display:flex;gap:12px;align-items:center}
.pfpImg{width:60px;height:60px;border-radius:20px;object-fit:cover;border:1px solid rgba(255,255,255,.10);background:rgba(255,255,255,.06)}
.locked{opacity:.65}

/* nav */
.nav{
  position:fixed;left:0;right:0;bottom:0;
  padding:12px 14px calc(env(safe-area-inset-bottom) + 12px);
  background:linear-gradient(180deg, rgba(6,10,18,0), rgba(6,10,18,.55), rgba(6,10,18,.86));
  backdrop-filter:blur(14px);
}
.navBar{
  max-width:560px;
  margin:0 auto;
  display:grid;
  grid-template-columns:repeat(6,1fr);
  gap:10px;
  padding:10px;
  border-radius:24px;
  border:1px solid rgba(255,255,255,.10);
  background:rgba(0,0,0,.18);
}
.navBtn{
  padding:10px 6px;
  border-radius:18px;
  border:1px solid rgba(255,255,255,.06);
  background:rgba(255,255,255,.04);
  text-align:center;
  font-size:10px;
  font-weight:1000;
  letter-spacing:1.5px;
  color:var(--muted);
  user-select:none;
}
.navBtn.active{
  color:var(--text);
  border-color:rgba(79,124,255,.26);
  background:rgba(79,124,255,.16);
}

/* toast */
.toast{
  position:fixed;left:50%;transform:translateX(-50%);
  bottom:calc(env(safe-area-inset-bottom) + 106px);
  background:rgba(0,0,0,.70);
  border:1px solid rgba(255,255,255,.12);
  padding:10px 12px;border-radius:999px;
  opacity:0;pointer-events:none;
  transition:opacity .16s ease, transform .16s ease;
  backdrop-filter:blur(14px);
  z-index:9999;
}
.toast.show{opacity:1;transform:translateX(-50%) translateY(-4px)}
</style>
</head>

<body>
<div class="safe">

  <!-- AUTH -->
  <div class="card authCard" id="authCard">
    <div style="font-weight:1000;letter-spacing:2px">CHOWDOLLA</div>
    <div class="small">fake bank game • no real money</div>
    <div class="sep"></div>

    <input id="authUser" placeholder="username e.g. chowibz" autocomplete="off" />
    <input id="authPass" type="password" placeholder="password" autocomplete="off" />

    <div class="row" style="margin-top:12px">
      <button onclick="doLogin()">login</button>
      <button class="btnGhost" onclick="doSignup()">signup</button>
    </div>

    <div class="small" style="margin-top:10px">tip: add to home screen for iOS / Android app feel</div>
  </div>

  <!-- APP -->
  <div id="app" class="hidden">

    <!-- HOME -->
    <div id="page-bank" class="page active">
      <div class="homeWrap">
        <div class="card homeCard">
          <div class="headerRow">
            <div class="brandLeft">
              <div class="logo">CD</div>
              <div class="brandText">
                <div class="t">CHOWDOLLA</div>
                <div class="s">FAKE BANK GAME  NO REAL MONEY</div>
              </div>
            </div>
            <div class="onlinePill" id="pillStatus">offline</div>
          </div>

          <div class="sep"></div>

          <div class="welcome">
            <div class="w1">welcome</div>
            <div class="w2" id="who">@user</div>
          </div>

          <div class="progressWrap">
            <div class="track"><div class="fill" id="lvlFill"></div></div>
            <div class="progLabel"><b id="lvlNow">0</b> / 1000 taps</div>
          </div>

          <div class="balanceBlock">
            <div class="b1">balance</div>
            <div class="b2"><span id="bal">0.00</span> CD</div>
            <div class="b3" id="lvlLine">level 1  •  +0.05 per tap</div>
          </div>

          <div class="statRow">
            <div class="statBox">
              <div class="k">taps</div>
              <div class="v" id="taps">0</div>
            </div>
            <div class="statBox">
              <div class="k">per tap</div>
              <div class="v" id="perTap">+0.05</div>
            </div>
          </div>

          <div class="claimRow">
            <div class="claimBox" id="btnMini" onclick="claimMini()">
              <div class="c1">MINI<br>CLAIM</div>
              <div class="c2">+0.50</div>
              <div class="c3" id="tMini">00:00</div>
            </div>

            <div class="claimBox" id="btnBig" onclick="claimBig()">
              <div class="c1">BIG<br>CLAIM</div>
              <div class="c2">+0.15</div>
              <div class="c3" id="tBig">00:00</div>
            </div>
          </div>

          <button class="tapBtn" onclick="tap()">TAP</button>
          <div class="tapHint">tap to earn  •  level up every 1000 taps</div>
        </div>

        <div class="card sectionCard" style="margin-top:14px">
          <div style="font-weight:1000;letter-spacing:1.5px">ACTIVE JOB</div>
          <div class="small" id="jobLine">no job selected</div>
          <div class="small muted2" id="jobPayLine">pick a job in JOBS tab</div>
        </div>
      </div>
    </div>

    <!-- SEND -->
    <div id="page-send" class="page">
      <div class="card sectionCard">
        <div style="font-weight:1000;letter-spacing:1.5px">TRANSFER</div>
        <div class="small">send CD to another username (must exist)</div>
        <div class="sep"></div>
        <input id="toUser" placeholder="to username" autocomplete="off" />
        <input id="amt" type="number" inputmode="decimal" placeholder="amount e.g. 1.25" />
        <button onclick="sendTransfer()">send</button>
        <div class="small" style="margin-top:10px" id="transferHint"></div>
      </div>
    </div>

    <!-- TXNS -->
    <div id="page-tx" class="page">
      <div class="card sectionCard">
        <div style="font-weight:1000;letter-spacing:1.5px">TRANSACTIONS</div>
        <div class="small">your last 50 transfers</div>
        <div class="sep"></div>
        <div class="small muted" id="txStatus">loading…</div>
        <div id="txList"></div>
      </div>
    </div>

    <!-- CHAT -->
    <div id="page-chat" class="page">
      <div class="card sectionCard">
        <div style="font-weight:1000;letter-spacing:1.5px">MESSAGES</div>
        <div class="small">send messages to usernames (must exist)</div>
        <div class="sep"></div>
        <input id="chatTo" placeholder="to username" autocomplete="off" />
        <input id="chatText" placeholder="message..." autocomplete="off" />
        <button onclick="sendMessage()">send</button>
        <div class="small" style="margin-top:10px" id="chatHint"></div>
        <div class="sep"></div>
        <div class="small muted2">latest 50</div>
        <div id="chatList"></div>
      </div>
    </div>

    <!-- JOBS (IN APP) -->
    <div id="page-jobs" class="page">
      <div class="card sectionCard">
        <div style="font-weight:1000;letter-spacing:1.5px">JOBS</div>
        <div class="small">unlock by taps • pays hourly (cap per day)</div>
        <div class="sep"></div>
        <div class="small muted" id="jobsStatus">loading…</div>
        <div id="jobsList"></div>
      </div>
    </div>

    <!-- ME -->
    <div id="page-me" class="page">
      <div class="card sectionCard">
        <div style="font-weight:1000;letter-spacing:1.5px">PROFILE</div>
        <div class="small" id="profLine">—</div>
        <div class="sep"></div>

        <div class="pfpRow">
          <img id="pfpImg" class="pfpImg" src="" alt="">
          <div style="flex:1">
            <div class="small muted2">profile pic url</div>
            <input id="pfpUrl" placeholder="https://..." autocomplete="off">
            <button class="btnGhost" onclick="savePfp()">save</button>
          </div>
        </div>

        <div class="sep"></div>
        <button class="btnBad" onclick="logout()">logout</button>
      </div>

      <div class="card sectionCard hidden" id="adminCard">
        <div style="font-weight:1000;letter-spacing:1.5px">ADMIN (chowibz)</div>
        <div class="small">set your balance</div>
        <div class="sep"></div>
        <input id="setBal" type="number" inputmode="decimal" placeholder="new balance e.g. 999.99" />
        <button class="btnGold" onclick="adminSetBalance()">update balance</button>
      </div>
    </div>

  </div>
</div>

<div class="nav hidden" id="nav">
  <div class="navBar">
    <div class="navBtn active" id="nav-bank" onclick="go('bank')">BANK</div>
    <div class="navBtn" id="nav-send" onclick="go('send')">SEND</div>
    <div class="navBtn" id="nav-tx" onclick="go('tx')">TXNS</div>
    <div class="navBtn" id="nav-chat" onclick="go('chat')">CHAT</div>
    <div class="navBtn" id="nav-jobs" onclick="go('jobs')">JOBS</div>
    <div class="navBtn" id="nav-me" onclick="go('me')">ME</div>
  </div>
</div>

<div class="toast" id="toast">—</div>

<script>
/* zoom lock best-effort */
document.addEventListener('gesturestart', e => e.preventDefault());
document.addEventListener('gesturechange', e => e.preventDefault());
document.addEventListener('gestureend', e => e.preventDefault());
document.addEventListener('touchmove', e => { if(e.scale && e.scale !== 1) e.preventDefault(); }, { passive:false });

/* firebase */
const firebaseConfig = {
  apiKey: "AIzaSyC7-SKTrNG5kMs5uoem-sun3-wUCtAYQMw",
  authDomain: "chowdolla.firebaseapp.com",
  projectId: "chowdolla",
  storageBucket: "chowdolla.firebasestorage.app",
  messagingSenderId: "976957921591",
  appId: "1:976957921591:web:a6adfd8203631ffc4f22b2"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

/* economy cents */
const TAP_BASE_CENTS = 5;          // 0.05
const MINI_CENTS = 50;             // 0.50
const BIG_CENTS  = 15;             // 0.15
const MINI_CD_MS = 60 * 1000;      // 1 min
const BIG_CD_MS  = 2 * 60 * 60 * 1000; // 2 hours

/* jobs (hourly pay, cap hours/day) */
const JOBS = [
  { id:"none",     name:"No Job",   reqTaps:0,    payPerHourGBP:0.00, hoursPerDay:0, note:"no pay" },
  { id:"cleaner",  name:"Cleaner",  reqTaps:100,  payPerHourGBP:6.50, hoursPerDay:6, note:"steady shift" },
  { id:"cashier",  name:"Cashier",  reqTaps:250,  payPerHourGBP:6.50, hoursPerDay:6, note:"till grind" },
  { id:"barista",  name:"Barista",  reqTaps:400,  payPerHourGBP:6.75, hoursPerDay:7, note:"coffee rush" },
  { id:"chef",     name:"Chef",     reqTaps:500,  payPerHourGBP:7.25, hoursPerDay:8, note:"full shift" },
  { id:"driver",   name:"Driver",   reqTaps:800,  payPerHourGBP:7.00, hoursPerDay:7, note:"on the road" }
];

const LS_USER = "chowdolla_user_v5";
const LS_HASH = "chowdolla_hash_v5";

let me=null, meHash=null, meDoc=null;
let unsubUser=null, unsubTx=null, unsubChat=null;
let timer=null, jobTimer=null;

const $ = (id)=>document.getElementById(id);

function toast(msg){
  const t=$("toast");
  t.textContent=msg;
  t.classList.add("show");
  setTimeout(()=>t.classList.remove("show"), 1200);
}
function setStatus(ok){ $("pillStatus").textContent = ok ? "online" : "offline"; }
function now(){ return Date.now(); }
function pad2(n){ return String(n).padStart(2,"0"); }
function msToMMSS(ms){
  if(ms<=0) return "READY";
  const s=Math.ceil(ms/1000);
  const m=Math.floor(s/60);
  const r=s%60;
  return pad2(m)+":"+pad2(r);
}
function centsToStr(c){ return (Math.floor(Number(c||0))/100).toFixed(2); }
function parseToCents(v){
  const n=Number(String(v||"").replace(/,/g,"").trim());
  if(!Number.isFinite(n)) return null;
  return Math.floor(n*100 + 1e-9);
}
function cleanUser(u){
  u=(u||"").trim().toLowerCase();
  if(!u||u.length<3) return null;
  if(!/^[a-z0-9_]+$/.test(u)) return null;
  return u;
}
function calcLevel(taps){
  const t=Math.max(0, Math.floor(Number(taps||0)));
  return Math.floor(t/1000)+1;
}
function perTapCents(level){
  return TAP_BASE_CENTS * Math.max(1, Math.floor(level||1));
}
async function sha256Hex(str){
  const enc=new TextEncoder().encode(str);
  const buf=await crypto.subtle.digest("SHA-256", enc);
  return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,"0")).join("");
}
function dayKey(ts){
  const d=new Date(ts);
  return d.getFullYear()+"-"+pad2(d.getMonth()+1)+"-"+pad2(d.getDate());
}
function getJob(jobId){
  return JOBS.find(j=>j.id===jobId) || JOBS[0];
}

function showApp(){
  $("authCard").classList.add("hidden");
  $("app").classList.remove("hidden");
  $("nav").classList.remove("hidden");
}
function showAuth(){
  $("authCard").classList.remove("hidden");
  $("app").classList.add("hidden");
  $("nav").classList.add("hidden");
}
function stopSubs(){
  if(unsubUser) unsubUser(); unsubUser=null;
  if(unsubTx) unsubTx(); unsubTx=null;
  if(unsubChat) unsubChat(); unsubChat=null;
  if(timer) clearInterval(timer); timer=null;
  if(jobTimer) clearInterval(jobTimer); jobTimer=null;
}

async function doSignup(){
  const u=cleanUser($("authUser").value);
  const p=$("authPass").value||"";
  if(!u) return toast("bad username");
  if(p.length<4) return toast("password too short");

  const hash=await sha256Hex(u+":"+p);
  const ref=db.collection("users").doc(u);
  const snap=await ref.get();
  if(snap.exists) return toast("username taken");

  await ref.set({
    pwHash:hash,
    isAdmin:(u==="chowibz"),
    balanceCents:10000,
    taps:0,
    level:1,
    nextMini:0,
    nextBig:0,
    pfp:"",
    job:"none",
    jobLastPaid:0,
    jobDayKey:"",
    jobHoursPaidToday:0,
    createdAt: firebase.firestore.FieldValue.serverTimestamp()
  });

  me=u; meHash=hash;
  localStorage.setItem(LS_USER, me);
  localStorage.setItem(LS_HASH, meHash);
  start();
  toast("signed up");
}

async function doLogin(){
  const u=cleanUser($("authUser").value);
  const p=$("authPass").value||"";
  if(!u) return toast("bad username");
  if(!p) return toast("enter password");

  const hash=await sha256Hex(u+":"+p);
  const ref=db.collection("users").doc(u);
  const snap=await ref.get();
  if(!snap.exists) return toast("no account. signup");

  const d=snap.data();
  if((d.pwHash||"")!==hash) return toast("wrong password");

  me=u; meHash=hash;
  localStorage.setItem(LS_USER, me);
  localStorage.setItem(LS_HASH, meHash);
  start();
  toast("logged in");
}

function start(){
  stopSubs();
  showApp();

  $("who").textContent="@"+me;
  $("profLine").textContent="@"+me+" • ChowDolla player";

  const userRef=db.collection("users").doc(me);

  unsubUser=userRef.onSnapshot(s=>{
    meDoc=s.data()||null;
    if(!meDoc) return;

    const taps=Math.floor(Number(meDoc.taps||0));
    const lvl=Number(meDoc.level||calcLevel(taps));
    const balC=Number(meDoc.balanceCents||0);
    const ptC=perTapCents(lvl);

    $("bal").textContent = centsToStr(balC);
    $("taps").textContent = taps.toLocaleString("en-GB");
    $("perTap").textContent = "+" + (ptC/100).toFixed(2);
    $("lvlLine").textContent = `level ${lvl}  •  +${(ptC/100).toFixed(2)} per tap`;

    const into = taps % 1000;
    const pct = Math.max(0, Math.min(100, (into/1000)*100));
    $("lvlFill").style.width = pct + "%";
    $("lvlNow").textContent = String(into);

    const pfp=(meDoc.pfp||"").trim();
    $("pfpImg").src = pfp || "";
    $("pfpUrl").value = pfp;

    const isAdminOk=(me==="chowibz") && (meDoc.isAdmin===true) && ((meDoc.pwHash||"")===meHash);
    $("adminCard").classList.toggle("hidden", !isAdminOk);

    const job=getJob(meDoc.job||"none");
    $("jobLine").textContent = (job.id==="none") ? "no job selected" : `${job.name} • unlock ${job.reqTaps} taps`;
    $("jobPayLine").textContent = (job.id==="none")
      ? "pick a job in JOBS tab"
      : `pays £${job.payPerHourGBP.toFixed(2)}/hour • ${job.hoursPerDay} hours/day max`;

    renderJobsUI();
    setStatus(true);
    renderTimers();
  }, ()=>setStatus(false));

  // TXNS (no orderBy -> no composite index)
  unsubTx=db.collection("transactions")
    .where("participants","array-contains", me)
    .limit(50)
    .onSnapshot(snap=>{
      const rows=[];
      snap.forEach(d=>{
        const t=d.data();
        const ts=t.ts?.toMillis ? t.ts.toMillis() : 0;
        rows.push({...t,__ts:ts});
      });
      rows.sort((a,b)=>b.__ts-a.__ts);

      $("txStatus").textContent = rows.length ? "live" : "no transactions yet";
      const box=$("txList"); box.innerHTML="";
      rows.forEach(t=>{
        const incoming=(t.to===me);
        const amt=centsToStr(t.amountCents||0);
        const when=t.ts?.toDate ? t.ts.toDate().toLocaleString("en-GB",{day:"2-digit",month:"short",hour:"2-digit",minute:"2-digit"}) : "";
        const el=document.createElement("div");
        el.className="listItem";
        el.innerHTML=`
          <div class="listTop">
            <div style="font-weight:1000">${incoming?`from @${t.from}`:`to @${t.to}`}</div>
            <div class="${incoming?"amtIn":"amtOut"}">${incoming?"+":"-"}${amt} CD</div>
          </div>
          <div class="small">${when}</div>
        `;
        box.appendChild(el);
      });
    }, err=>{
      console.error(err);
      $("txStatus").textContent="can’t load";
    });

  // CHAT (no orderBy -> no composite index)
  unsubChat=db.collection("messages")
    .where("participants","array-contains", me)
    .limit(50)
    .onSnapshot(snap=>{
      const rows=[];
      snap.forEach(d=>{
        const m=d.data();
        const ts=m.ts?.toMillis ? m.ts.toMillis() : 0;
        rows.push({...m,__ts:ts});
      });
      rows.sort((a,b)=>b.__ts-a.__ts);

      const box=$("chatList");
      box.innerHTML = rows.length ? "" : `<div class="small muted">no messages yet</div>`;
      rows.forEach(m=>{
        const mine=(m.from===me);
        const when=m.ts?.toDate ? m.ts.toDate().toLocaleString("en-GB",{day:"2-digit",month:"short",hour:"2-digit",minute:"2-digit"}) : "";
        const el=document.createElement("div");
        el.className="listItem";
        el.innerHTML=`
          <div class="listTop">
            <div style="font-weight:1000">${mine?`to @${m.to}`:`from @${m.from}`}</div>
            <div class="small">${when}</div>
          </div>
          <div class="msgBubble ${mine?"msgMe":""}">${(m.text||"").replace(/</g,"&lt;")}</div>
        `;
        box.appendChild(el);
      });
    });

  timer=setInterval(renderTimers, 250);
  jobTimer=setInterval(processJobPay, 60*1000);
  processJobPay();
  go("bank");
}

function logout(){
  stopSubs();
  localStorage.removeItem(LS_USER);
  localStorage.removeItem(LS_HASH);
  me=null; meHash=null; meDoc=null;
  showAuth();
  toast("logged out");
}

function go(p){
  ["bank","send","tx","chat","jobs","me"].forEach(x=>{
    $("page-"+x).classList.toggle("active", x===p);
    $("nav-"+x).classList.toggle("active", x===p);
  });
  if(p==="jobs") renderJobsUI();
}

function renderTimers(){
  if(!meDoc) return;
  const n=now();
  const leftMini=Number(meDoc.nextMini||0)-n;
  const leftBig =Number(meDoc.nextBig||0)-n;

  const readyMini=leftMini<=0;
  const readyBig =leftBig<=0;

  $("tMini").textContent = readyMini ? "READY" : msToMMSS(leftMini);
  $("tBig").textContent  = readyBig  ? "READY" : msToMMSS(leftBig);

  $("btnMini").classList.toggle("ready", readyMini);
  $("btnBig").classList.toggle("ready", readyBig);
}

async function tap(){
  if(!me||!meDoc) return;
  const ref=db.collection("users").doc(me);
  try{
    await db.runTransaction(async tx=>{
      const snap=await tx.get(ref);
      if(!snap.exists) throw "missing";
      const d=snap.data();
      const taps=Math.floor(Number(d.taps||0))+1;
      const level=calcLevel(taps);
      const earnC=perTapCents(level);
      const balanceCents=Math.floor(Number(d.balanceCents||0))+earnC;
      tx.update(ref,{taps,level,balanceCents});
    });
  }catch(e){
    console.error(e);
    toast("tap failed");
  }
}

async function claimMini(){ return claimCommon("nextMini", MINI_CD_MS, MINI_CENTS); }
async function claimBig(){ return claimCommon("nextBig",  BIG_CD_MS,  BIG_CENTS ); }

async function claimCommon(field, cooldownMs, amountCents){
  if(!me||!meDoc) return;
  const ref=db.collection("users").doc(me);
  try{
    await db.runTransaction(async tx=>{
      const snap=await tx.get(ref);
      if(!snap.exists) throw "missing";
      const d=snap.data();
      const n=now();
      const next=Number(d[field]||0);
      if(next>n) throw "not ready";
      const balanceCents=Math.floor(Number(d.balanceCents||0))+amountCents;
      tx.update(ref,{balanceCents,[field]:n+cooldownMs});
    });
    toast("claimed +" + (amountCents/100).toFixed(2));
  }catch(e){
    if(String(e).includes("not ready")) return toast("not ready yet");
    console.error(e);
    toast("claim failed");
  }
}

async function sendTransfer(){
  if(!me||!meDoc) return;
  const to=cleanUser($("toUser").value);
  const amtC=parseToCents($("amt").value);
  $("transferHint").textContent="";

  if(!to) return toast("enter username");
  if(to===me) return toast("cant send to yourself");
  if(amtC===null||amtC<=0) return toast("enter amount");
  if(Number(meDoc.balanceCents||0)<amtC) return toast("not enough");

  const fromRef=db.collection("users").doc(me);
  const toRef=db.collection("users").doc(to);

  try{
    await db.runTransaction(async tx=>{
      const fromSnap=await tx.get(fromRef);
      const toSnap=await tx.get(toRef);
      if(!toSnap.exists) throw "user not found";

      const fromBal=Math.floor(Number(fromSnap.data().balanceCents||0));
      const toBal=Math.floor(Number(toSnap.data().balanceCents||0));
      if(fromBal<amtC) throw "no funds";

      tx.update(fromRef,{balanceCents:fromBal-amtC});
      tx.update(toRef,{balanceCents:toBal+amtC});
    });

    await db.collection("transactions").add({
      from:me,to,
      participants:[me,to],
      amountCents:amtC,
      ts:firebase.firestore.FieldValue.serverTimestamp()
    });

    $("amt").value="";
    toast("sent " + (amtC/100).toFixed(2) + " to @" + to);
  }catch(e){
    console.error(e);
    if(String(e).includes("user not found")){
      $("transferHint").textContent="user doesn’t exist yet. they must signup first";
      return toast("user not found");
    }
    toast("transfer failed");
  }
}

async function sendMessage(){
  if(!me||!meDoc) return;

  const to=cleanUser($("chatTo").value);
  const text=($("chatText").value||"").trim();
  $("chatHint").textContent="";

  if(!to) return toast("enter username");
  if(!text) return toast("type message");
  if(text.length>300) return toast("too long");

  const toSnap=await db.collection("users").doc(to).get();
  if(!toSnap.exists){
    $("chatHint").textContent="user doesn’t exist yet. they must signup first";
    return toast("user not found");
  }

  await db.collection("messages").add({
    from:me,to,
    participants:[me,to],
    text,
    ts:firebase.firestore.FieldValue.serverTimestamp()
  });

  $("chatText").value="";
  toast("sent");
}

async function savePfp(){
  if(!me) return;
  const url=($("pfpUrl").value||"").trim();
  await db.collection("users").doc(me).update({pfp:url});
  toast("saved");
}

async function adminSetBalance(){
  if(me!=="chowibz"||!meDoc||meDoc.isAdmin!==true||(meDoc.pwHash||"")!==meHash) return toast("nope");
  const newC=parseToCents($("setBal").value);
  if(newC===null||newC<0) return toast("bad number");
  await db.collection("users").doc(me).update({balanceCents:newC});
  $("setBal").value="";
  toast("updated");
}

/* JOBS UI + SELECT */
function renderJobsUI(){
  if(!meDoc){ $("jobsStatus").textContent="loading…"; return; }
  const taps=Math.floor(Number(meDoc.taps||0));
  const current=(meDoc.job||"none");

  $("jobsStatus").textContent = `you have ${taps} taps`;
  const box=$("jobsList");
  box.innerHTML="";

  JOBS.forEach(j=>{
    const unlocked=taps>=j.reqTaps;
    const active=current===j.id;

    const el=document.createElement("div");
    el.className="listItem" + (!unlocked ? " locked" : "");
    el.innerHTML=`
      <div class="listTop">
        <div style="font-weight:1000">${j.name}</div>
        <div class="badge ${active?"badgeOk":""}">${active?"ACTIVE":(unlocked?"UNLOCKED":"LOCKED")}</div>
      </div>
      <div class="small" style="margin-top:6px">requires: ${j.reqTaps} taps</div>
      <div class="small">pay: £${j.payPerHourGBP.toFixed(2)}/hour • ${j.hoursPerDay} hours/day</div>
      <div class="small muted2">${j.note}</div>
      <div class="row" style="margin-top:10px">
        <button class="${active?"btnGhost":""}" style="flex:1" ${unlocked?"":"disabled"} onclick="setJob('${j.id}')">
          ${active?"selected":(unlocked?"choose job":"need more taps")}
        </button>
      </div>
    `;
    box.appendChild(el);
  });
}

async function setJob(jobId){
  if(!me||!meDoc) return;

  const taps=Math.floor(Number(meDoc.taps||0));
  const job=getJob(jobId);
  if(jobId!=="none" && taps<job.reqTaps) return toast("not unlocked");

  await db.collection("users").doc(me).update({
    job: jobId,
    jobLastPaid: 0,
    jobDayKey: "",
    jobHoursPaidToday: 0
  });
  toast("job set");
}

/* AUTO JOB PAY (pays in CD at 1 CD = £1) */
async function processJobPay(){
  if(!me||!meDoc) return;

  const job=getJob(meDoc.job||"none");
  if(job.id==="none" || job.payPerHourGBP<=0 || job.hoursPerDay<=0) return;

  const ref=db.collection("users").doc(me);
  const payCents=Math.floor(job.payPerHourGBP*100);

  try{
    await db.runTransaction(async tx=>{
      const snap=await tx.get(ref);
      if(!snap.exists) return;
      const d=snap.data();

      const dkNow=dayKey(now());
      let dk=d.jobDayKey||"";
      let hoursPaid=Math.floor(Number(d.jobHoursPaidToday||0));
      let lastPaid=Math.floor(Number(d.jobLastPaid||0));

      if(dk!==dkNow){
        dk=dkNow; hoursPaid=0; lastPaid=0;
      }

      const n=now();
      const base = lastPaid>0 ? lastPaid : n;
      const hoursElapsed = Math.floor((n-base)/(60*60*1000));

      if(hoursElapsed<=0){
        if(lastPaid===0){
          tx.update(ref,{jobDayKey:dk,jobHoursPaidToday:hoursPaid,jobLastPaid:n});
        }
        return;
      }

      const remaining=Math.max(0, job.hoursPerDay-hoursPaid);
      const payHours=Math.min(remaining, hoursElapsed);
      if(payHours<=0){
        tx.update(ref,{jobDayKey:dk,jobHoursPaidToday:hoursPaid,jobLastPaid:base + hoursElapsed*(60*60*1000)});
        return;
      }

      const add = payHours * payCents;
      const newBal = Math.floor(Number(d.balanceCents||0)) + add;
      const newHours = hoursPaid + payHours;
      const newLast = base + payHours*(60*60*1000);

      tx.update(ref,{
        balanceCents:newBal,
        jobDayKey:dk,
        jobHoursPaidToday:newHours,
        jobLastPaid:newLast
      });
    });
  }catch(e){
    console.error(e);
  }
}

/* boot session */
(async function boot(){
  const u=localStorage.getItem(LS_USER);
  const h=localStorage.getItem(LS_HASH);
  if(!u||!h) return;

  const snap=await db.collection("users").doc(u).get().catch(()=>null);
  if(!snap||!snap.exists) return;
  const d=snap.data();
  if((d.pwHash||"")!==h) return;

  me=u; meHash=h;
  start();
})();

/* expose for onclick */
window.doLogin=doLogin;
window.doSignup=doSignup;
window.go=go;
window.logout=logout;
window.tap=tap;
window.claimMini=claimMini;
window.claimBig=claimBig;
window.sendTransfer=sendTransfer;
window.sendMessage=sendMessage;
window.savePfp=savePfp;
window.adminSetBalance=adminSetBalance;
window.setJob=setJob;
</script>
</body>
</html>
