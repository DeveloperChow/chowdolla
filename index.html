<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no" />
<meta name="theme-color" content="#0b0f14" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
<meta name="apple-mobile-web-app-title" content="ChowDolla" />
<title>CHOWDOLLA — Fake Bank Game</title>

<!-- Firebase (single-file compat) -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
:root{
  --bg:#0b0f14;
  --panel:#111827;
  --panel2:#0f172a;
  --text:#e9eef7;
  --muted:rgba(233,238,247,.6);
  --line:rgba(255,255,255,.08);
  --brand:#4f7cff;
  --good:#22c55e;
  --gold:#fbbf24;
  --bad:#ef4444;
  --shadow: 0 18px 50px rgba(0,0,0,.45);
  --radius:18px;
}
*{box-sizing:border-box; -webkit-tap-highlight-color: transparent}
html,body{height:100%}
body{
  margin:0;
  font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial;
  color:var(--text);
  background:
    radial-gradient(1100px 700px at 20% 0%, #141f34 0%, var(--bg) 60%),
    radial-gradient(900px 600px at 90% 10%, #1c1236 0%, transparent 55%),
    var(--bg);
  overflow:hidden;
}
.safe{
  padding: calc(env(safe-area-inset-top) + 10px) 14px calc(env(safe-area-inset-bottom) + 88px);
  height:100%;
  overflow:auto;
  overscroll-behavior: none;
}
.topbar{
  position:sticky; top:0;
  padding: 10px 10px 14px;
  background: linear-gradient(180deg, rgba(11,15,20,.92), rgba(11,15,20,.65), rgba(11,15,20,0));
  backdrop-filter: blur(12px);
  z-index:10;
}
.brandWrap{
  display:flex; align-items:center; justify-content:space-between; gap:10px;
  border:1px solid var(--line);
  border-radius: var(--radius);
  background: linear-gradient(180deg, rgba(17,24,39,.95), rgba(17,24,39,.62));
  box-shadow: var(--shadow);
  padding: 12px 12px;
}
.brandLeft{display:flex; align-items:center; gap:10px}
.logo{
  width:44px; height:44px; border-radius:16px;
  display:grid; place-items:center;
  background: radial-gradient(circle at 30% 30%, #8aa9ff 0%, var(--brand) 35%, #2a45b0 100%);
  box-shadow: 0 12px 28px rgba(79,124,255,.22), inset 0 0 0 1px rgba(255,255,255,.14);
  font-weight:900; letter-spacing:.5px;
}
.brandTxt{display:flex; flex-direction:column; gap:2px}
.brandTxt .t{font-weight:900; letter-spacing:2px; font-size:15px}
.brandTxt .s{font-size:11px; color:var(--muted); letter-spacing:1px}
.pill{
  font-size:11px;
  padding:7px 10px;
  border-radius:999px;
  border:1px solid var(--line);
  background: rgba(0,0,0,.18);
  color:var(--muted);
  white-space:nowrap;
}

.card{
  border:1px solid var(--line);
  background: linear-gradient(180deg, rgba(17,24,39,.85), rgba(15,23,42,.65));
  border-radius: var(--radius);
  box-shadow: var(--shadow);
  padding:14px;
  margin: 12px 0;
}
.row{display:flex; gap:10px; align-items:center}
.col{flex:1}
.center{text-align:center}
.muted{color:var(--muted)}
.bigMoney{
  font-size:36px; font-weight:900; letter-spacing:1px;
  margin: 6px 0 0;
}
.subMoney{
  font-size:12px; color:var(--muted); letter-spacing:1px;
}
.sep{height:1px; background:var(--line); margin:12px 0}
input{
  width:100%;
  padding:12px 12px;
  border-radius:14px;
  border:1px solid var(--line);
  background: rgba(0,0,0,.18);
  color:var(--text);
  outline:none;
  font-size:16px;
}
button{
  border:none;
  border-radius:16px;
  padding:12px 12px;
  font-size:16px;
  font-weight:800;
  color:var(--text);
  background: rgba(79,124,255,.92);
  box-shadow: 0 10px 24px rgba(79,124,255,.18);
  transform: translateZ(0);
  transition: transform .08s ease, filter .2s ease, opacity .2s ease;
  user-select:none;
}
button:active{transform: scale(.985)}
.btnGhost{
  background: rgba(255,255,255,.06);
  box-shadow:none;
  border:1px solid var(--line);
}
.btnBad{background: rgba(239,68,68,.92); box-shadow: 0 10px 24px rgba(239,68,68,.15)}
.btnGood{background: rgba(34,197,94,.92); box-shadow: 0 10px 24px rgba(34,197,94,.15)}
.btnGold{background: rgba(251,191,36,.92); color:#101010; box-shadow: 0 10px 24px rgba(251,191,36,.15)}

.page{display:none; animation: fadeIn .18s ease}
.page.active{display:block}
@keyframes fadeIn{from{opacity:.5; transform: translateY(6px)} to{opacity:1; transform: translateY(0)}}

.arcadeZone{
  display:grid;
  grid-template-columns: 1fr 1.35fr 1fr;
  gap:12px;
  align-items:center;
  margin-top:12px;
}
.arcadeBtn{
  border-radius: 22px;
  padding: 14px 10px;
  background: rgba(255,255,255,.06);
  border:1px solid var(--line);
  box-shadow: none;
}
.arcadeBtn .aT{font-size:12px; letter-spacing:1px; color:var(--muted)}
.arcadeBtn .aV{font-size:18px; font-weight:900; margin-top:2px}
.arcadeBtn.ready{background: rgba(34,197,94,.14); border-color: rgba(34,197,94,.35)}
.arcadeBtn.ready .aV{color: var(--good)}
.arcadeBtn.locked{opacity:.85}

.tapCore{
  width: 168px; height: 168px;
  border-radius: 999px;
  margin: 0 auto;
  display:grid; place-items:center;
  background: radial-gradient(circle at 30% 30%, rgba(34,197,94,.95), rgba(34,197,94,.7), rgba(16,185,129,.55));
  box-shadow: 0 18px 40px rgba(34,197,94,.18), inset 0 0 0 1px rgba(255,255,255,.18);
  border: 1px solid rgba(255,255,255,.12);
  font-size: 40px;
  font-weight: 1000;
  letter-spacing: .5px;
  cursor:pointer;
  user-select:none;
  transition: transform .07s ease;
}
.tapCore:active{transform: scale(.985)}
.tapHint{margin-top:10px; font-size:12px; color:var(--muted); letter-spacing:1px}

.toast{
  position:fixed;
  left:50%;
  transform:translateX(-50%);
  bottom: calc(env(safe-area-inset-bottom) + 86px);
  background: rgba(0,0,0,.7);
  border: 1px solid rgba(255,255,255,.12);
  color: var(--text);
  padding: 10px 12px;
  border-radius: 999px;
  font-size: 13px;
  opacity:0;
  pointer-events:none;
  transition: opacity .18s ease, transform .18s ease;
  backdrop-filter: blur(12px);
  z-index:999;
}
.toast.show{opacity:1; transform: translateX(-50%) translateY(-4px)}

.nav{
  position:fixed;
  left:0; right:0;
  bottom:0;
  padding: 10px 14px calc(env(safe-area-inset-bottom) + 10px);
  background: linear-gradient(180deg, rgba(11,15,20,0), rgba(11,15,20,.65), rgba(11,15,20,.92));
  backdrop-filter: blur(12px);
}
.navBar{
  display:grid;
  grid-template-columns: repeat(4, 1fr);
  gap:10px;
  border:1px solid var(--line);
  border-radius: 22px;
  padding: 10px;
  background: rgba(17,24,39,.78);
  box-shadow: var(--shadow);
}
.navBtn{
  padding: 10px 8px;
  border-radius: 18px;
  background: rgba(255,255,255,.06);
  border:1px solid rgba(255,255,255,.06);
  font-weight:900;
  font-size:12px;
  letter-spacing:1px;
  text-align:center;
  color: var(--muted);
}
.navBtn.active{
  background: rgba(79,124,255,.18);
  border-color: rgba(79,124,255,.28);
  color: var(--text);
}
.kpi{
  display:flex; gap:10px; margin-top:10px;
}
.kpi .box{
  flex:1;
  border:1px solid var(--line);
  background: rgba(0,0,0,.16);
  border-radius: 16px;
  padding: 10px;
}
.kpi .box .k{font-size:11px; color:var(--muted); letter-spacing:1px}
.kpi .box .v{margin-top:2px; font-weight:900; font-size:16px}
.small{font-size:12px; color:var(--muted)}
</style>
</head>

<body>
<div class="topbar">
  <div class="brandWrap">
    <div class="brandLeft">
      <div class="logo">CD</div>
      <div class="brandTxt">
        <div class="t">CHOWDOLLA</div>
        <div class="s">FAKE BANK GAME • NO REAL MONEY</div>
      </div>
    </div>
    <div class="pill" id="pillStatus">offline</div>
  </div>
</div>

<div class="safe wrap">

  <!-- LOGIN -->
  <div class="card" id="loginCard">
    <div style="font-weight:900; letter-spacing:1px; font-size:16px">enter game</div>
    <div class="small" style="margin-top:6px">pick a username • it’s shared across devices</div>
    <input id="inUser" placeholder="username e.g. chowibz" autocomplete="off" />
    <button style="margin-top:12px" onclick="doLogin()">login</button>
    <div class="small" style="margin-top:10px">tip: add to home screen for full iOS app feel</div>
  </div>

  <!-- APP -->
  <div id="app" class="hidden">

    <!-- BANK PAGE -->
    <div id="page-bank" class="page active">
      <div class="card center">
        <div class="muted" style="letter-spacing:1px">welcome</div>
        <div style="font-weight:1000; font-size:18px; margin-top:2px" id="who">@user</div>

        <div class="sep"></div>

        <div class="subMoney">balance</div>
        <div class="bigMoney" id="bal">0 CD</div>
        <div class="subMoney" id="lvl">level 1 • +1 per tap</div>

        <div class="kpi">
          <div class="box">
            <div class="k">taps</div>
            <div class="v" id="taps">0</div>
          </div>
          <div class="box">
            <div class="k">per tap</div>
            <div class="v" id="perTap">+1</div>
          </div>
        </div>

        <div class="arcadeZone">
          <button id="btn20" class="arcadeBtn locked" onclick="claim(20)">
            <div class="aT">MINI CLAIM</div>
            <div class="aV">+20</div>
            <div class="aT" id="t20">00:00</div>
          </button>

          <div>
            <div class="tapCore" onclick="tap()">TAP</div>
            <div class="tapHint">tap = earn ChowDollas • level up every 1000 taps</div>
          </div>

          <button id="btn150" class="arcadeBtn locked" onclick="claim(150)">
            <div class="aT">BIG CLAIM</div>
            <div class="aV">+150</div>
            <div class="aT" id="t150">00:00</div>
          </button>
        </div>
      </div>
    </div>

    <!-- EARN PAGE (just info + same actions) -->
    <div id="page-earn" class="page">
      <div class="card">
        <div style="font-weight:1000; letter-spacing:1px">earn</div>
        <div class="small" style="margin-top:6px">
          tap gives CD based on your level. level = floor(taps/1000)+1. level 5 = +5 per tap etc
        </div>
        <div class="sep"></div>
        <button class="btnGood" onclick="tap()">tap now (+<span id="earnTapTxt">1</span>)</button>
        <div class="row" style="margin-top:10px">
          <button class="arcadeBtn col" id="btn20b" onclick="claim(20)">
            <div class="aT">MINI</div><div class="aV">+20</div><div class="aT" id="t20b">00:00</div>
          </button>
          <button class="arcadeBtn col" id="btn150b" onclick="claim(150)">
            <div class="aT">BIG</div><div class="aV">+150</div><div class="aT" id="t150b">00:00</div>
          </button>
        </div>
      </div>
    </div>

    <!-- TRANSFER PAGE -->
    <div id="page-transfer" class="page">
      <div class="card">
        <div style="font-weight:1000; letter-spacing:1px">transfer</div>
        <div class="small" style="margin-top:6px">send CD to another username (must exist)</div>
        <div class="sep"></div>
        <input id="toUser" placeholder="to username showing in game" autocomplete="off" />
        <input id="amt" type="number" inputmode="numeric" placeholder="amount" />
        <button onclick="sendTransfer()">send</button>
        <button class="btnGhost" style="margin-top:10px" onclick="createUserHint()">don’t exist yet?</button>
        <div class="small" style="margin-top:10px" id="transferHint"></div>
      </div>
    </div>

    <!-- PROFILE / ADMIN -->
    <div id="page-profile" class="page">
      <div class="card">
        <div style="font-weight:1000; letter-spacing:1px">profile</div>
        <div class="small" style="margin-top:6px" id="profLine">—</div>
        <div class="sep"></div>
        <button class="btnBad" onclick="logout()">logout</button>
      </div>

      <div class="card hidden" id="adminCard">
        <div style="font-weight:1000; letter-spacing:1px">admin (chowibz)</div>
        <div class="small" style="margin-top:6px">set your balance (game admin power)</div>
        <div class="sep"></div>
        <input id="setBal" type="number" inputmode="numeric" placeholder="new balance" />
        <button class="btnGold" onclick="adminSetBalance()">update balance</button>
      </div>
    </div>

  </div>
</div>

<div class="nav hidden" id="nav">
  <div class="navBar">
    <div class="navBtn active" id="nav-bank" onclick="go('bank')">BANK</div>
    <div class="navBtn" id="nav-earn" onclick="go('earn')">EARN</div>
    <div class="navBtn" id="nav-transfer" onclick="go('transfer')">SEND</div>
    <div class="navBtn" id="nav-profile" onclick="go('profile')">ME</div>
  </div>
</div>

<div class="toast" id="toast">—</div>

<script>
/* ====== FIREBASE CONFIG (PASTE YOURS) ====== */
const firebaseConfig = {
  apiKey: "AIzaSyC7-SKTrNG5kMs5uoem-sun3-wUCtAYQMw",
  authDomain: "chowdolla.firebaseapp.com",
  projectId: "chowdolla"
};
/* ========================================= */

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

const LS_KEY = "chowdolla_user_v1";

let me = null;
let meDoc = null;
let unsub = null;
let tickTimer = null;

const $ = (id)=>document.getElementById(id);

function toast(msg){
  const t = $("toast");
  t.textContent = msg;
  t.classList.add("show");
  setTimeout(()=>t.classList.remove("show"), 1200);
}

function softHaptic(){
  try{ navigator.vibrate && navigator.vibrate(8); }catch(e){}
}

function setStatus(ok){
  $("pillStatus").textContent = ok ? "online" : "offline";
  $("pillStatus").style.color = ok ? "rgba(233,238,247,.8)" : "rgba(233,238,247,.55)";
}

function fmtCD(n){
  const x = Math.floor(Number(n||0));
  return x.toLocaleString("en-GB") + " CD";
}

function pad2(n){ return String(n).padStart(2,"0"); }

function msToMMSS(ms){
  if(ms <= 0) return "READY";
  const s = Math.ceil(ms/1000);
  const m = Math.floor(s/60);
  const r = s % 60;
  return pad2(m) + ":" + pad2(r);
}

function now(){ return Date.now(); }

async function ensureUserDoc(username){
  const ref = db.collection("users").doc(username);
  const snap = await ref.get();
  if(!snap.exists){
    const base = {
      balance: 100,
      taps: 0,
      level: 1,
      nextClaim20: 0,
      nextClaim150: 0,
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    };
    await ref.set(base);
  }
  return ref;
}

async function doLogin(){
  const u = $("inUser").value.trim().toLowerCase();
  if(!u) return toast("enter a username");
  if(u.length < 3) return toast("username too short");
  if(!/^[a-z0-9_]+$/.test(u)) return toast("use letters/numbers/_ only");

  $("inUser").blur();
  toast("logging in…");

  try{
    me = u;
    localStorage.setItem(LS_KEY, me);
    const ref = await ensureUserDoc(me);
    startApp(ref);
  }catch(e){
    console.error(e);
    toast("login failed");
  }
}

function startApp(ref){
  $("loginCard").classList.add("hidden");
  $("app").classList.remove("hidden");
  $("nav").classList.remove("hidden");

  $("who").textContent = "@" + me;
  $("profLine").textContent = "@" + me + " • synced across devices";
  if(me === "chowibz") $("adminCard").classList.remove("hidden");

  if(unsub) unsub();
  unsub = ref.onSnapshot(s=>{
    meDoc = s.data() || null;
    if(!meDoc) return;
    render();
    setStatus(true);
  }, err=>{
    console.error(err);
    setStatus(false);
  });

  if(tickTimer) clearInterval(tickTimer);
  tickTimer = setInterval(renderTimers, 250);

  go("bank");
}

function logout(){
  if(unsub) unsub();
  unsub = null;
  me = null;
  meDoc = null;
  localStorage.removeItem(LS_KEY);

  $("loginCard").classList.remove("hidden");
  $("app").classList.add("hidden");
  $("nav").classList.add("hidden");
  $("adminCard").classList.add("hidden");

  toast("logged out");
}

function go(p){
  const pages = ["bank","earn","transfer","profile"];
  pages.forEach(x=>{
    $("page-"+x).classList.toggle("active", x===p);
    $("nav-"+x).classList.toggle("active", x===p);
  });
}

function calcLevel(taps){
  const t = Math.max(0, Math.floor(Number(taps||0)));
  return Math.floor(t / 1000) + 1;
}

function render(){
  const bal = Number(meDoc.balance||0);
  const taps = Number(meDoc.taps||0);
  const lvl = Number(meDoc.level||calcLevel(taps));
  const per = lvl;

  $("bal").textContent = fmtCD(bal);
  $("lvl").textContent = `level ${lvl} • +${per} per tap`;
  $("taps").textContent = Math.floor(taps).toLocaleString("en-GB");
  $("perTap").textContent = "+" + per;
  $("earnTapTxt").textContent = per;

  renderTimers();
}

function renderTimers(){
  if(!meDoc) return;

  const n = now();
  const n20 = Number(meDoc.nextClaim20||0);
  const n150 = Number(meDoc.nextClaim150||0);

  const left20 = n20 - n;
  const left150 = n150 - n;

  const ready20 = left20 <= 0;
  const ready150 = left150 <= 0;

  const t20txt = ready20 ? "READY" : msToMMSS(left20);
  const t150txt = ready150 ? "READY" : msToMMSS(left150);

  // main page
  $("t20").textContent = t20txt;
  $("t150").textContent = t150txt;
  $("btn20").classList.toggle("ready", ready20);
  $("btn20").classList.toggle("locked", !ready20);
  $("btn150").classList.toggle("ready", ready150);
  $("btn150").classList.toggle("locked", !ready150);

  // earn page mirrors
  $("t20b").textContent = t20txt;
  $("t150b").textContent = t150txt;
  $("btn20b").classList.toggle("ready", ready20);
  $("btn20b").classList.toggle("locked", !ready20);
  $("btn150b").classList.toggle("ready", ready150);
  $("btn150b").classList.toggle("locked", !ready150);
}

async function tap(){
  if(!me || !meDoc) return;
  softHaptic();

  const ref = db.collection("users").doc(me);
  try{
    await db.runTransaction(async tx=>{
      const snap = await tx.get(ref);
      if(!snap.exists) throw "missing user";
      const d = snap.data();
      const taps = Math.floor(Number(d.taps||0)) + 1;
      const level = calcLevel(taps);
      const earn = level; // per tap = level
      const balance = Math.floor(Number(d.balance||0)) + earn;

      tx.update(ref, { taps, level, balance });
    });
  }catch(e){
    console.error(e);
    toast("tap failed");
  }
}

async function claim(amount){
  if(!me || !meDoc) return;
  softHaptic();

  const amt = Number(amount);
  if(![20,150].includes(amt)) return;

  const cooldown = (amt === 20) ? (60 * 1000) : (2 * 60 * 60 * 1000);
  const field = (amt === 20) ? "nextClaim20" : "nextClaim150";

  const ref = db.collection("users").doc(me);

  try{
    await db.runTransaction(async tx=>{
      const snap = await tx.get(ref);
      if(!snap.exists) throw "missing user";
      const d = snap.data();
      const n = now();
      const next = Number(d[field]||0);
      if(next > n) throw "not ready";

      const balance = Math.floor(Number(d.balance||0)) + amt;
      tx.update(ref, { balance, [field]: n + cooldown });
    });

    toast("claimed +" + amt);
  }catch(e){
    if(String(e).includes("not ready")) return toast("not ready yet");
    console.error(e);
    toast("claim failed");
  }
}

async function sendTransfer(){
  if(!me || !meDoc) return;

  const to = $("toUser").value.trim().toLowerCase();
  const amt = Math.floor(Number($("amt").value));
  $("transferHint").textContent = "";

  if(!to) return toast("enter a username");
  if(to === me) return toast("you can’t send to yourself");
  if(!/^[a-z0-9_]+$/.test(to)) return toast("bad username");
  if(!amt || amt <= 0) return toast("enter amount");
  if(amt > 1e12) return toast("nah too big");
  if(Number(meDoc.balance||0) < amt) return toast("not enough CD");

  softHaptic();

  const fromRef = db.collection("users").doc(me);
  const toRef = db.collection("users").doc(to);

  try{
    await db.runTransaction(async tx=>{
      const fromSnap = await tx.get(fromRef);
      const toSnap = await tx.get(toRef);
      if(!fromSnap.exists) throw "missing sender";
      if(!toSnap.exists) throw "user not found";

      const fromBal = Math.floor(Number(fromSnap.data().balance||0));
      const toBal = Math.floor(Number(toSnap.data().balance||0));
      if(fromBal < amt) throw "no funds";

      tx.update(fromRef, { balance: fromBal - amt });
      tx.update(toRef, { balance: toBal + amt });
    });

    $("amt").value = "";
    toast("sent " + amt + " CD to @" + to);
  }catch(e){
    console.error(e);
    if(String(e).includes("user not found")){
      $("transferHint").textContent = "that user doesn’t exist yet. tell them to log in once so their account gets created";
      return toast("user not found");
    }
    toast("transfer failed");
  }
}

function createUserHint(){
  $("transferHint").textContent = "tell them to open the app and log in once using their username. then you can send to them";
  toast("done");
}

async function adminSetBalance(){
  if(me !== "chowibz") return toast("nope");
  const v = Math.floor(Number($("setBal").value));
  if(!Number.isFinite(v)) return toast("enter a number");
  if(v < 0) return toast("can’t be negative");

  const ref = db.collection("users").doc(me);
  try{
    await ref.update({ balance: v });
    toast("balance updated");
    $("setBal").value = "";
  }catch(e){
    console.error(e);
    toast("failed");
  }
}

/* auto login */
(function boot(){
  const saved = localStorage.getItem(LS_KEY);
  if(saved){
    me = saved;
    ensureUserDoc(me).then(ref=>startApp(ref)).catch(()=>{ localStorage.removeItem(LS_KEY); });
  }
})();
</script>
</body>
</html>
