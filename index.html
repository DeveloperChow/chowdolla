<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>ChowDolla</title>

<!-- PWA -->
<meta name="theme-color" content="#0b0f14">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
body{margin:0;background:#0b0f14;color:#fff;font-family:system-ui}
.hidden{display:none}
.card{margin:14px;padding:14px;background:#121827;border-radius:16px}
input,button{width:100%;padding:12px;border-radius:12px;border:none;margin-top:8px}
button{background:#4f7cff;color:#fff;font-weight:700}
.nav{position:fixed;bottom:0;left:0;right:0;display:flex;background:#0f1520}
.nav button{flex:1;border-radius:0}
.chat{border-top:1px solid #222;padding-top:8px;margin-top:8px}
.msg{padding:6px;margin:4px 0;border-radius:8px;background:#1b2233}
.me{background:#4f7cff}
</style>
</head>

<body>

<div id="login" class="card">
  <h2>ChowDolla</h2>
  <input id="lu" placeholder="username">
  <input id="lp" type="password" placeholder="password">
  <button onclick="signup()">Sign up</button>
  <button onclick="login()">Login</button>
</div>

<div id="app" class="hidden">

  <div class="card">
    <b id="userTag"></b><br>
    Balance: <span id="bal"></span><br>
    <input id="pfp" placeholder="profile pic URL">
    <button onclick="savePfp()">Save Profile Pic</button>
    <img id="pfpImg" style="width:80px;border-radius:50%;margin-top:6px">
  </div>

  <div class="card">
    <button onclick="tap()">TAP (+0.05)</button>
    <button onclick="claim()">Claim +0.50</button>
  </div>

  <div class="card">
    <h3>Transfer</h3>
    <input id="to" placeholder="to user">
    <input id="amt" placeholder="amount">
    <button onclick="send()">Send</button>
  </div>

  <div class="card">
    <h3>Transactions</h3>
    <div id="txs"></div>
  </div>

  <div class="card">
    <h3>Messages</h3>
    <input id="chatTo" placeholder="username">
    <input id="chatMsg" placeholder="message">
    <button onclick="sendMsg()">Send</button>
    <div id="msgs" class="chat"></div>
  </div>

  <div class="card hidden" id="admin">
    <h3>ADMIN</h3>
    <input id="setBal" placeholder="new balance">
    <button onclick="adminSet()">Set Balance</button>
  </div>

</div>

<div class="nav hidden" id="nav">
  <button onclick="logout()">Logout</button>
</div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyC7-SKTrNG5kMs5uoem-sun3-wUCtAYQMw",
  authDomain: "chowdolla.firebaseapp.com",
  projectId: "chowdolla",
  storageBucket: "chowdolla.firebasestorage.app",
  messagingSenderId: "976957921591",
  appId: "1:976957921591:web:a6adfd8203631ffc4f22b2"
};
firebase.initializeApp(firebaseConfig);
const db=firebase.firestore();

let me=null,doc=null;

function h(s){return btoa(s)}

async function signup(){
  const u=lu.value.toLowerCase(),p=h(lp.value);
  const r=db.collection("users").doc(u);
  if((await r.get()).exists) return alert("taken");
  await r.set({pw:p,b:10000,pfp:""});
  me=u;start();
}
async function login(){
  const u=lu.value.toLowerCase(),p=h(lp.value);
  const r=db.collection("users").doc(u);
  const s=await r.get();
  if(!s.exists||s.data().pw!==p) return alert("wrong");
  me=u;start();
}
function start(){
  loginDiv(false);
  db.collection("users").doc(me).onSnapshot(s=>{
    doc=s.data();
    userTag.innerText="@"+me;
    bal.innerText=(doc.b/100).toFixed(2);
    pfpImg.src=doc.pfp||"";
    if(me==="chowibz") admin.classList.remove("hidden");
  });
  db.collection("transactions").where("p","array-contains",me)
  .onSnapshot(s=>{
    txs.innerHTML="";
    s.forEach(d=>{
      const t=d.data();
      txs.innerHTML+=`<div>${t.from} â†’ ${t.to} ${(t.a/100).toFixed(2)}</div>`;
    });
  });
  db.collection("messages").where("p","array-contains",me)
  .onSnapshot(s=>{
    msgs.innerHTML="";
    s.forEach(d=>{
      const m=d.data();
      msgs.innerHTML+=`<div class="msg ${m.from===me?'me':''}">${m.from}: ${m.msg}</div>`;
    });
  });
}
function loginDiv(v){
  login.classList.toggle("hidden",!v);
  app.classList.toggle("hidden",v);
  nav.classList.toggle("hidden",v);
}
function tap(){db.collection("users").doc(me).update({b:doc.b+5})}
function claim(){db.collection("users").doc(me).update({b:doc.b+50})}
async function send(){
  const t=to.value,a=Math.floor(Number(amt.value)*100);
  const r=db.collection("users").doc(t);
  if(!(await r.get()).exists) return alert("no user");
  await db.collection("users").doc(me).update({b:doc.b-a});
  await r.update({b:firebase.firestore.FieldValue.increment(a)});
  db.collection("transactions").add({from:me,to:t,a,p:[me,t]});
}
function sendMsg(){
  db.collection("messages").add({from:me,to:chatTo.value,msg:chatMsg.value,p:[me,chatTo.value]});
}
function savePfp(){db.collection("users").doc(me).update({pfp:pfp.value})}
function adminSet(){db.collection("users").doc(me).update({b:Math.floor(Number(setBal.value)*100)})}
function logout(){location.reload()}
</script>
</body>
</html>
